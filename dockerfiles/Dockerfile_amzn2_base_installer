# Copyright (c) 2021 Habana Labs, Ltd.
#
# SPDX-License-Identifier: Apache-2.0
#
# HabanaLabs Dockerfile base installer layer for Amazon Linux 2
FROM amazonlinux:2
ARG ARTIFACTORY_URL
ARG VERSION
ARG REVISION

RUN yum update -y && yum install -y \
    ethtool-4.8-10.amzn2.x86_64 \
    python-devel \
    python3 \
    python3-devel \
    python3-pip \
    python3-tkinter \
    wget \
    lsof

# Install jemalloc-3.6.0-1.el7.x86_64 package with required /lib64/libjemalloc.so.1 lib need for topologies
RUN yum install -y https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-14.noarch.rpm && \
    yum install -y jemalloc && \
    yum clean all && rm -rf /var/cache/yum

# Install development tools and cmake for habana-horovod compilation sdist package
RUN yum groupinstall -y "Development Tools"
RUN yum install -y sudo system-lsb-core cmake

RUN echo "[habanalabs]" > /etc/yum.repos.d/habanalabs.repo && \
    echo "name=Habana AWS Linux repo" >> /etc/yum.repos.d/habanalabs.repo && \
    echo "baseurl=https://${ARTIFACTORY_URL}/artifactory/AmazonLinux2" >> /etc/yum.repos.d/habanalabs.repo && \
    echo "gpgkey=https://${ARTIFACTORY_URL}/artifactory/AmazonLinux2/repodata/repomd.xml.key" >> /etc/yum.repos.d/habanalabs.repo

RUN yum install -y habanalabs-thunk-"$VERSION"-"$REVISION".amzn2 && \
    yum install -y habanalabs-firmware-tools-"$VERSION"-"$REVISION".amzn2 && \
    yum install -y habanalabs-graph-"$VERSION"-"$REVISION".amzn2 && \
    yum install -y habanalabs-aeon-"$VERSION"-"$REVISION".amzn2

RUN rm -f /etc/yum.repos.d/habanalabs.repo && \
    yum clean all && rm -rf /var/cache/yum

# There is no need to store pip installation files inside docker image
RUN pip3 config set global.no-cache-dir false

RUN echo "export LANG=en_US.UTF-8" >> /root/.bashrc
RUN export LANG=en_US.UTF-8
ENV GC_KERNEL_PATH=/usr/lib/habanalabs/libtpc_kernels.so
ENV HABANA_LOGS=/var/log/habana_logs/