# Copyright (c) 2022 HabanaLabs, Ltd.
#
# SPDX-License-Identifier: Apache-2.0
#
# HabanaLabs Dockerfile Tensorflow installer layer for Ubuntu18.04/Ubuntu20.04
ARG BASE_NAME
ARG VERSION
ARG REVISION
FROM ${BASE_NAME}:${VERSION}-${REVISION}
ARG VERSION
ARG REVISION
ARG TF_VERSION
ARG ARTIFACTORY_URL

ENV TF_MODULES_RELEASE_BUILD=/usr/lib/habanalabs/
ENV PYTHONPATH=/usr/lib/habanalabs/:/root

COPY requirements-tensorflow-cpu-"$TF_VERSION".txt requirements-tensorflow-cpu-"$TF_VERSION".txt

# Install python packages inside conda base environment
RUN . /opt/miniconda/bin/activate && \
    python3 -m pip install pip==21.0.1 \
    setuptools==60.5.0 && \
    python3 -m pip install --use-pep517 tensorflow-cpu==${TF_VERSION} && \
    python3 -m pip install -r requirements-tensorflow-cpu-"$TF_VERSION".txt && \
    python3 -m pip install habana-tensorflow=="${VERSION}"."${REVISION}" && \
    python3 -m pip install habana-horovod=="${VERSION}"."${REVISION}"

# Regarding to issue that occurs only on Ubuntu 18.04 with termcolor which is dependency for tensorflow-cpu
# add --use-pep517 to tensorflow-cpu or installation termcolor will fail and affect tensorflow-cpu
RUN python3 -m pip install pip==21.0.1 \
    setuptools==60.5.0 && \
    python3 -m pip install --use-pep517 tensorflow-cpu==${TF_VERSION} && \
    python3 -m pip install -r requirements-tensorflow-cpu-"$TF_VERSION".txt && \
    rm requirements-tensorflow-cpu-"$TF_VERSION".txt && \
    python3 -m pip install habana-tensorflow=="${VERSION}"."${REVISION}" && \
    python3 -m pip install habana-horovod=="${VERSION}"."${REVISION}"

RUN echo "source /etc/profile.d/habanalabs.sh" >> ~/.bashrc && \
    rm -rf /tmp/*