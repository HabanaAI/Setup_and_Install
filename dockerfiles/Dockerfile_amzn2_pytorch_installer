# Copyright (c) 2023 HabanaLabs, Ltd.
#
# SPDX-License-Identifier: Apache-2.0
#
# HabanaLabs Dockerfile PyTorch installer layer for Amazon Linux 2
ARG BASE_NAME
ARG VERSION
ARG REVISION
FROM ${BASE_NAME}:${VERSION}-${REVISION}
ARG PT_VERSION
ARG VERSION
ARG REVISION
ARG ARTIFACTORY_URL
ARG HABANA_PIP_VERSION="22.3"
ARG GPERFTOOLS_PREFIX="/usr/local"
ARG GPERFTOOLS="gperftools-2.7"

ENV LANG=en_US.UTF-8
ENV PYTHONPATH=/root:/usr/lib/habanalabs/

RUN yum install -y \
    curl \
    redhat-lsb-core \
    numactl-devel \
    cairo-devel \
    iproute \
    libjpeg-devel \
    zlib-devel \
    lapack-devel \
    openblas-devel \
    numactl && \
    yum clean all

RUN amazon-linux-extras install epel -y
RUN yum install -y \
    moreutils && \
    yum clean all

# Since there is an open bug in gperftools 2.6 installed from yum install,
# Hence, Compile & Install gperftools 2.7. Later it might be removed and installed through yum install.
RUN wget --no-verbose https://github.com/gperftools/gperftools/releases/download/${GPERFTOOLS}/${GPERFTOOLS}.tar.gz && \
    tar -xvf ${GPERFTOOLS}.tar.gz && \
    cd ${GPERFTOOLS} && \
    ./configure --prefix="${GPERFTOOLS_PREFIX}" && \
    make -j && \
    make install && \
    ln -s /usr/local/include/google /usr/include/gperftools && \
    cd - && \
    rm -rf ${GPERFTOOLS}* && \
    /sbin/ldconfig

RUN wget --no-verbose https://"${ARTIFACTORY_URL}"/artifactory/gaudi-pt-modules/"${VERSION}"/"${REVISION}"\
/pytorch/amzn2/pytorch_modules-v"${PT_VERSION}"_"${VERSION}"_"${REVISION}".tgz && \
    mkdir /root/habanalabs /root/habanalabs/pytorch_temp && \
    tar -xf pytorch_modules-v"${PT_VERSION}"_"${VERSION}"_"${REVISION}".tgz -C /root/habanalabs/pytorch_temp/. && \
    python3 -m pip install pip=="${HABANA_PIP_VERSION}" && \
    pip3 install mpi4py==3.1.4 && \
    pip3 install $(grep -ivE "#|pytorch-lightning" /root/habanalabs/pytorch_temp/requirements-pytorch.txt | grep .) --no-warn-script-location && \
    pip3 install /root/habanalabs/pytorch_temp/*.whl && \
    pip3 install $(grep "pytorch-lightning" /root/habanalabs/pytorch_temp/requirements-pytorch.txt) && \
    pip3 install -U habana-lightning-plugins=="${VERSION}"."${REVISION}.1" && \
    /sbin/ldconfig && \
    echo "source /etc/profile.d/habanalabs.sh" >> ~/.bashrc && \
    pip3 uninstall -y pillow && \
    pip3 uninstall -y pillow-simd && \
    pip3 install pillow-simd==7.0.0.post3 && \
    rm -rf /root/habanalabs/pytorch_temp/ && \
    rm -rf pytorch_modules-v"${PT_VERSION}"_"${VERSION}"_"${REVISION}".tgz

ENV LD_PRELOAD="${GPERFTOOLS_PREFIX}/lib/libtcmalloc.so"
ENV TCMALLOC_LARGE_ALLOC_REPORT_THRESHOLD=7516192768

RUN rm -rf /tmp/*